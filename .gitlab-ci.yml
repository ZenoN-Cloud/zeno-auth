stages:
  - lint
  - test
  - security
  - build

variables:
  # Убедись, что версия Go соответствует той, что указана в go.mod
  GO_VERSION: "1.21"
  # GCP_PROJECT_ID и GCP_PROJECT_NUMBER должны быть определены в переменных CI/CD GitLab
  GCR_HOSTNAME: "gcr.io"
  IMAGE_NAME: "zeno-auth"
  IMAGE_TAG: "$GCR_HOSTNAME/$GCP_PROJECT_ID/$IMAGE_NAME"

# --- Lint Stage ---
go-fmt:
  stage: lint
  image: golang:${GO_VERSION}-alpine
  script:
    - gofmt -l . | tee /tmp/fmt-output
    - test ! -s /tmp/fmt-output
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

golangci-lint:
  stage: lint
  image: golangci/golangci-lint:v1.55.2-alpine
  script:
    - golangci-lint run -v --timeout 5m
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# --- Test Stage ---
unit-tests:
  stage: test
  image: golang:${GO_VERSION}-alpine
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: zeno_auth_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    DATABASE_URL: "postgres://test:test@postgres:5432/zeno_auth_test?sslmode=disable"
  before_script:
    - apk add --no-cache git make gcc musl-dev
    - go mod download
  script:
    - go test -short -coverprofile=coverage.out ./...
  artifacts:
    paths:
      - coverage.out
    expire_in: 1 day
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# --- Security Stage ---
gosec:
  stage: security
  image: securego/gosec:latest
  script:
    - gosec ./...
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

dependency-scanning:
  stage: security
  image: golang:${GO_VERSION}-alpine
  before_script:
    - go install golang.org/x/vuln/cmd/govulncheck@latest
  script:
    - govulncheck ./...
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# --- Build Stage ---
build-and-push-to-gcr:
  stage: build
  image: google/cloud-sdk:latest
  services:
    - name: docker:dind
      command: ["--mtu=1460"] # Решает возможные проблемы с сетью в GitLab Runner
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://iam.googleapis.com/projects/${GCP_PROJECT_NUMBER}/locations/global/workloadIdentityPools/gitlab-pool/providers/gitlab-provider-v2
  before_script:
    - echo "Logging into GCP using OIDC..."
    - echo $GITLAB_OIDC_TOKEN > /tmp/gitlab_oidc_token.txt
    - gcloud iam workload-identity-pools create-cred-config
        "projects/${GCP_PROJECT_NUMBER}/locations/global/workloadIdentityPools/gitlab-pool/providers/gitlab-provider-v2"
        --service-account="zeno-auth-sa@${GCP_PROJECT_ID}.iam.gserviceaccount.com"
        --output-file=/tmp/gcp-cred-config.json
        --credential-source-file=/tmp/gitlab_oidc_token.txt
    - gcloud auth login --cred-file=/tmp/gcp-cred-config.json
    - gcloud auth configure-docker $GCR_HOSTNAME --quiet
  script:
    - echo "Building Docker image..."
    - docker build -t "$IMAGE_TAG:$CI_COMMIT_SHORT_SHA" .
    - echo "Tagging image as latest..."
    - docker tag "$IMAGE_TAG:$CI_COMMIT_SHORT_SHA" "$IMAGE_TAG:latest"
    - echo "Pushing image to GCR..."
    - docker push "$IMAGE_TAG:$CI_COMMIT_SHORT_SHA"
    - docker push "$IMAGE_TAG:latest"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "develop"'
