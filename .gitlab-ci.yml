stages:
  - lint
  - test
  - security
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  PROJECT_ID: "zeno-cy-dev-001"
  REGION: "europe-west3"
  SERVICE_NAME: "zeno-auth-dev"
  REPO_NAME: "zeno-auth"
  GO_VERSION: "1.25"
  # GCP Project Numbers for Workload Identity
  GCP_PROJECT_NUMBER: "899549698924"  # zeno-cy-dev-001
  GCP_PROJECT_NUMBER_PROD: "YOUR_PROD_PROJECT_NUMBER"  # Replace with actual project number for zeno-cy-prod-001

# Lint stage
golangci-lint:
  stage: lint
  image: golangci/golangci-lint:v1.60-alpine
  script:
    - golangci-lint run -v --timeout 5m || true
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

go-fmt:
  stage: lint
  image: golang:${GO_VERSION}-alpine
  script:
    - gofmt -l . | tee /tmp/fmt-output
    - test ! -s /tmp/fmt-output
  only:
    - merge_requests
    - main
    - develop

# Test stage
unit-tests:
  stage: test
  image: golang:${GO_VERSION}-alpine
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: zeno_auth_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    DATABASE_URL: "postgres://test:test@postgres:5432/zeno_auth_test?sslmode=disable"
    CGO_ENABLED: "1"
  before_script:
    - apk add --no-cache git make gcc musl-dev
    - go mod download
  script:
    - go test -short -coverprofile=coverage.out -covermode=atomic ./...
    - go tool cover -func=coverage.out
  coverage: '/total:.*?(\d+\.\d+)%/'
  artifacts:
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.out
      - coverage.xml
  only:
    - merge_requests
    - main
    - develop

integration-tests:
  stage: test
  image: golang:${GO_VERSION}-alpine
  services:
    - postgres:15-alpine
  variables:
    POSTGRES_DB: zeno_auth_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    DATABASE_URL: "postgres://test:test@postgres:5432/zeno_auth_test?sslmode=disable"
    CGO_ENABLED: "1"
  before_script:
    - apk add --no-cache git make gcc musl-dev
    - go mod download
  script:
    - go test ./test -v -tags=integration
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Security stage
.gosec:
  stage: security
  image: securego/gosec:latest
  script:
    - gosec ./...
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

secret-detection:
  stage: security
  image: alpine:latest
  before_script:
    - apk add --no-cache git
    - wget -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
    - tar -xzf gitleaks.tar.gz
    - chmod +x gitleaks
  script:
    - ./gitleaks detect --source . --verbose --no-git || true
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

dependency-scanning:
  stage: security
  image: golang:${GO_VERSION}-alpine
  before_script:
    - apk add --no-cache git
    - go install golang.org/x/vuln/cmd/govulncheck@latest
  script:
    - govulncheck ./... || true
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Build stage
build-docker:
  stage: build
  image: google/cloud-sdk:alpine
  services:
    - docker:24-dind
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://iam.googleapis.com/projects/${GCP_PROJECT_NUMBER}/locations/global/workloadIdentityPools/gitlab-pool/providers/gitlab-provider-v2
  before_script:
    - apk add --no-cache docker-cli
    - echo $GITLAB_OIDC_TOKEN > /tmp/gitlab_oidc_token.txt
    - gcloud iam workload-identity-pools create-cred-config
        projects/${GCP_PROJECT_NUMBER}/locations/global/workloadIdentityPools/gitlab-pool/providers/gitlab-provider-v2
        --service-account=zeno-auth-sa@${PROJECT_ID}.iam.gserviceaccount.com
        --output-file=/tmp/gcp-cred-config.json
        --credential-source-file=/tmp/gitlab_oidc_token.txt
    - gcloud auth login --cred-file=/tmp/gcp-cred-config.json
    - gcloud config set project $PROJECT_ID
    - gcloud auth configure-docker $REGION-docker.pkg.dev
  script:
    - |
      IMAGE_TAG="$REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/zeno-auth:$CI_COMMIT_SHA"
      IMAGE_LATEST="$REGION-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/zeno-auth:latest"
      
      docker build -t $IMAGE_TAG -t $IMAGE_LATEST .
      docker push $IMAGE_TAG
      docker push $IMAGE_LATEST
      
      echo "IMAGE_TAG=$IMAGE_TAG" >> build.env
  artifacts:
    reports:
      dotenv: build.env
  only:
    - main
    - develop

# Deploy stage
deploy:dev:
  stage: deploy
  image: google/cloud-sdk:alpine
  dependencies:
    - build-docker
  before_script:
    - |
      if [ -z "$GCP_SERVICE_ACCOUNT_KEY" ]; then
        echo "âš ï¸  GCP_SERVICE_ACCOUNT_KEY not set, skipping deploy"
        exit 0
      fi
    - echo $GCP_SERVICE_ACCOUNT_KEY | base64 -d > gcp-key.json
    - gcloud auth activate-service-account --key-file gcp-key.json
    - gcloud config set project $PROJECT_ID
  script:
    - |
      gcloud run deploy $SERVICE_NAME \
        --image=$IMAGE_TAG \
        --region=$REGION \
        --platform=managed \
        --service-account=zeno-auth-sa@$PROJECT_ID.iam.gserviceaccount.com \
        --add-cloudsql-instances=$PROJECT_ID:$REGION:zeno-auth-db-dev \
        --set-secrets=DATABASE_URL=zeno-auth-database-url:latest,JWT_PRIVATE_KEY=zeno-auth-jwt-private-key:latest,SENDGRID_API_KEY=zeno-auth-sendgrid-api-key:latest \
        --set-env-vars=ENV=development,APP_NAME=zeno-auth,CORS_ALLOWED_ORIGINS=https://storage.googleapis.com,EMAIL_FROM=noreply@em2292.zeno-cy.com,EMAIL_FROM_NAME=ZenoN-Cloud \
        --port=8080 \
        --memory=512Mi \
        --cpu=1 \
        --timeout=300 \
        --max-instances=10 \
        --min-instances=0 \
        --concurrency=80 \
        --allow-unauthenticated
      
      SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
      echo "ðŸš€ Deployed to: $SERVICE_URL"
      
      # Health check
      sleep 10
      curl -f "$SERVICE_URL/health" || exit 1
  environment:
    name: development
    url: https://zeno-auth-dev-umu7aajgeq-ey.a.run.app
    on_stop: stop:dev
  only:
    - main

stop:dev:
  stage: deploy
  image: google/cloud-sdk:alpine
  before_script:
    - echo $GCP_SERVICE_ACCOUNT_KEY | base64 -d > gcp-key.json
    - gcloud auth activate-service-account --key-file gcp-key.json
    - gcloud config set project $PROJECT_ID
  script:
    - gcloud run services delete $SERVICE_NAME --region=$REGION --quiet
  environment:
    name: development
    action: stop
  when: manual
  only:
    - main

deploy:prod:
  stage: deploy
  image: google/cloud-sdk:alpine
  dependencies:
    - build-docker
  variables:
    SERVICE_NAME: "zeno-auth-prod"
    PROJECT_ID: "zeno-cy-prod-001"
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://iam.googleapis.com/projects/${GCP_PROJECT_NUMBER_PROD}/locations/global/workloadIdentityPools/gitlab-pool/providers/gitlab-provider
  before_script:
    - echo $GITLAB_OIDC_TOKEN > /tmp/gitlab_oidc_token.txt
    - gcloud iam workload-identity-pools create-cred-config
        projects/${GCP_PROJECT_NUMBER_PROD}/locations/global/workloadIdentityPools/gitlab-pool/providers/gitlab-provider
        --service-account=zeno-auth-sa@${PROJECT_ID}.iam.gserviceaccount.com
        --output-file=/tmp/gcp-cred-config.json
        --credential-source-file=/tmp/gitlab_oidc_token.txt
    - gcloud auth login --cred-file=/tmp/gcp-cred-config.json
    - gcloud config set project $PROJECT_ID
  script:
    - |
      gcloud run deploy $SERVICE_NAME \
        --image=$IMAGE_TAG \
        --region=$REGION \
        --platform=managed \
        --service-account=zeno-auth-sa@$PROJECT_ID.iam.gserviceaccount.com \
        --add-cloudsql-instances=$PROJECT_ID:$REGION:zeno-auth-db-prod \
        --set-secrets=DATABASE_URL=zeno-auth-database-url:latest,JWT_PRIVATE_KEY=zeno-auth-jwt-private-key:latest,SENDGRID_API_KEY=zeno-auth-sendgrid-api-key:latest \
        --set-env-vars=ENV=production,APP_NAME=zeno-auth,CORS_ALLOWED_ORIGINS=https://zeno-cy.com,EMAIL_FROM=noreply@em2292.zeno-cy.com,EMAIL_FROM_NAME=ZenoN-Cloud \
        --port=8080 \
        --memory=1Gi \
        --cpu=2 \
        --timeout=300 \
        --max-instances=50 \
        --min-instances=1 \
        --concurrency=80 \
        --allow-unauthenticated
      
      SERVICE_URL=$(gcloud run services describe $SERVICE_NAME --region=$REGION --format="value(status.url)")
      echo "ðŸš€ Production deployed to: $SERVICE_URL"
      
      # Health check
      sleep 10
      curl -f "$SERVICE_URL/health" || exit 1
  environment:
    name: production
    url: https://zeno-auth-prod.zeno-cy.com
  when: manual
  only:
    - main
